---
description: Drizzle ORM database schema and query patterns
globs: src/db/**/*.ts
---

# Database Patterns

## Schema Definition

Define tables with Drizzle in `src/db/schema.ts`:

```typescript
import { 
  pgTable, 
  uuid, 
  varchar, 
  timestamp, 
  decimal,
  boolean,
  text
} from "drizzle-orm/pg-core";

export const tableName = pgTable("table_name", {
  id: uuid("id").defaultRandom().primaryKey(),
  userId: uuid("user_id")
    .references(() => users.id, { onDelete: "cascade" })
    .notNull(),
  name: varchar("name", { length: 100 }).notNull(),
  amount: decimal("amount", { precision: 15, scale: 2 }).notNull(),
  isArchived: boolean("is_archived").default(false),
  notes: text("notes"),
  createdAt: timestamp("created_at").defaultNow().notNull(),
  updatedAt: timestamp("updated_at").defaultNow().notNull(),
});
```

## Type Exports

Always export types from schema:

```typescript
export type Transaction = typeof transactions.$inferSelect;
export type NewTransaction = typeof transactions.$inferInsert;
```

## Relations

Define relations for the query builder:

```typescript
import { relations } from "drizzle-orm";

export const transactionsRelations = relations(transactions, ({ one, many }) => ({
  user: one(users, {
    fields: [transactions.userId],
    references: [users.id],
  }),
  category: one(categories, {
    fields: [transactions.categoryId],
    references: [categories.id],
  }),
  transactionTags: many(transactionTags),
}));
```

## Query Patterns

```typescript
import { db } from "@/db";
import { eq, and, desc, gte, lte } from "drizzle-orm";

// Simple query with relations
const items = await db.query.transactions.findMany({
  where: eq(transactions.userId, userId),
  with: {
    category: true,
    account: true,
  },
  orderBy: [desc(transactions.transactionDate)],
  limit: 20,
});

// Complex conditions
const filtered = await db.query.transactions.findMany({
  where: and(
    eq(transactions.userId, userId),
    gte(transactions.transactionDate, startDate),
    lte(transactions.transactionDate, endDate)
  ),
});
```

## Drizzle Kit Commands

```bash
yarn db:generate  # Generate migrations
yarn db:migrate   # Run migrations
yarn db:push      # Push schema changes (dev)
yarn db:studio    # Open Drizzle Studio
```
